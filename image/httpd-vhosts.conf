# uses "Define" variables for apache instead 
# of the OS env var comming from docker
# so that the httpd -S tool can be used
Include /usr/local/apache2/conf/extra/define-vars.conf

Listen 443
ServerName ${RENATER_SP_HTTPD_SERVER_NAME}
UseCanonicalName On

ShibConfig /etc/shibboleth/shibboleth2.xml

ServerAdmin ${RENATER_SP_ADMIN_MAIL}
LogFormat "${RENATER_SP_HTTPD_LOG_FORMAT}" combined

# for apache beeing able to log real IP addresses instead of the above reverse proxy one
RemoteIPHeader X-Forwarded-For

<VirtualHost *:443>
  UseCanonicalName On
  ProxyPreserveHost On

  LogLevel  ${RENATER_SP_HTTPD_LOG_LEVEL}
  ErrorLog  /var/log/apache2/error.log
  CustomLog /var/log/apache2/access.log combined

  # use a self-signed certificate for apache2 cause this reverse proxy
  # will be behind another one with a correct SSL certificate
  SSLEngine on
  SSLProtocol all
  SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key


  # thanks to this section, metadata of the service provider are published
  # https://${RENATER_SP_HTTPD_SERVER_NAME}/Shibboleth.sso/Metadata
  <Location /Shibboleth.sso/>
    AuthType shibboleth
    ShibRequestSetting requireSession 0
    Require shibboleth
  </Location>
  # this section is used for shibb errors templates.
  <Location /shibboleth-sp>
    Satisfy Any
    Allow from all
  </Location>
  Alias /shibboleth-sp/main.css /usr/share/shibboleth/main.css
 
  # hook to be able to overload virtualhost config
  Include /usr/local/apache2/conf/extra/httpd-vhosts.inc.conf

  # Here goes your public routes
  <Macro MACRO_PUBLIC_PROXY_TO $public_location_path $public_proxy_to_url>
    <Location $public_location_path>
      Include /usr/local/apache2/conf/extra/httpd-vhosts.public_proxy.inc.conf

      ProxyPass        $public_proxy_to_url status= retry=5
      ProxyPassReverse $public_proxy_to_url
    </Location>
  </Macro>
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_0} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_0}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_1} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_1}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_2} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_2}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_3} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_3}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_4} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_4}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_5} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_5}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_6} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_6}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_7} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_7}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_8} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_8}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_9} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_9}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_10} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_10}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_11} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_11}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_12} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_12}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_13} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_13}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_14} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_14}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_15} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_15}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_16} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_16}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_17} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_17}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_18} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_18}
  Use MACRO_PUBLIC_PROXY_TO ${RENATER_SP_HTTPD_PUBLIC_PATH_19} ${RENATER_SP_HTTPD_PUBLIC_PROXY_TO_19}


  # Here goes your protected routes
  <Macro MACRO_PROTECTED_PROXY_TO $protected_location_path $protected_proxy_to_url $protected_require_0 $protected_require_1 $protected_require_2>
    <Location $protected_location_path>
      AuthType shibboleth
      ShibRequestSetting requireSession 1
      ShibRequestSetting exportDuplicateValues 0
      ShibUseHeaders On
      <RequireAll>
        Require shib-session
        $protected_require_0
        $protected_require_1
        $protected_require_2
      </RequireAll>

      Include /usr/local/apache2/conf/extra/httpd-vhosts.protected_proxy.inc.conf

      ProxyPass        $protected_proxy_to_url retry=5
      ProxyPassReverse $protected_proxy_to_url
    </Location>
  </Macro>
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_0}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_0_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_0_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_0_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_1}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_1_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_1_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_1_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_2}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_2}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_2_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_2_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_2_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_3}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_3}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_3_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_3_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_3_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_4}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_4}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_4_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_4_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_4_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_5}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_5}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_5_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_5_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_5_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_6}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_6}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_6_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_6_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_6_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_7}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_7}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_7_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_7_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_7_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_8}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_8}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_8_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_8_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_8_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_9}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_9}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_9_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_9_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_9_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_10}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_10}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_10_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_10_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_10_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_11}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_11}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_11_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_11_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_11_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_12}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_12}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_12_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_12_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_12_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_13}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_13}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_13_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_13_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_13_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_14}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_14}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_14_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_14_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_14_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_15}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_15}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_15_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_15_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_15_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_16}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_16}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_16_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_16_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_16_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_17}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_17}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_17_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_17_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_17_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_18}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_18}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_18_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_18_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_18_2}"
  Use MACRO_PROTECTED_PROXY_TO "${RENATER_SP_HTTPD_PROTECTED_PATH_19}" "${RENATER_SP_HTTPD_PROTECTED_PROXY_TO_19}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_19_0}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_19_1}" "${RENATER_SP_HTTPD_PROTECTED_REQUIRE_19_2}"


</VirtualHost>
